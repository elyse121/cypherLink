{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Members</title>
  <link rel="icon" type="image/x-icon" href="{% static 'images/bbbm.ico' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="{% static 'DASHBOARD/CSS/allmembers.css' %}" rel="stylesheet">

  <style>
    /* Toast notification styling */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    .custom-toast {
      background-color: white;
      border-left: 4px solid;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .toast-success { border-left-color: #198754; }
    .toast-error { border-left-color: #dc3545; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>
  
<div class="dashboard-header">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6">
        <h1 class="h3 mb-0">Member's Management</h1>
        <p class="text-muted mb-0">Manage all registered members</p>
      </div>
      <div class="col-md-6 text-end">
        <a href="javascript:history.back()" class="btn btn-secondary">
          <i class="fas fa-arrow-left me-1"></i> Back
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container py-4">
  <!-- Toast Notification Container -->
  <div id="toastContainer" class="toast-container"></div>

  <div class="row">
    <div class="col-md-4">
      <div class="stats-card total-members">
        <i class="fas fa-users"></i>
        <div class="count" id="totalMembers">{{ total_members }}</div>
        <div class="label">Total Members</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="stats-card banned-users">
        <i class="fas fa-user-slash"></i>
        <div class="count" id="bannedMembers">{{ banned_members }}</div>
        <div class="label">Banned Users</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="stats-card active-users">
        <i class="fas fa-user-check"></i>
        <div class="count" id="activeMembers">{{ active_members }}</div>
        <div class="label">Active Users</div>
      </div>
    </div>
  </div>

  <!-- Member Table -->
  <div class="member-table-container">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Member</th>
            <th>Email</th>
            <th>Role</th>
            <th>Joined</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="membersTableBody">
          {% for member in members %}
          <tr id="member-row-{{ member.id }}">
            <td>{{ member.id }}</td>
            <td>
              <div class="d-flex align-items-center">
                <img src="{{ member.avatar }}" alt="{{ member.username }}" class="member-avatar me-2" style="width:40px; height:40px; border-radius:50%;">
                <div>
                  <div class="fw-semibold">{{ member.username }}</div>
                  <small class="text-muted">{{ member.username }}</small>
                </div>
              </div>
            </td>
            <td>{{ member.email }}</td>
            <td>{{ member.role }}</td>
            <td>{{ member.joined }}</td>
            <td>
              <span class="status-badge status-{{ member.status|lower }}" id="status-badge-{{ member.id }}">
                <i class="fas {% if member.status|lower == 'active' %}fa-check-circle{% else %}fa-ban{% endif %} me-1"></i>
                {{ member.status }}
              </span>
            </td>
            <td>
              <!-- Ban button -->
              <button
                class="btn btn-sm btn-danger toggle-status-btn {% if member.status|lower != 'active' %}d-none{% endif %}"
                data-member-id="{{ member.id }}"
                data-action="ban"
                data-url-ban="{% url 'ban_user' member.id %}"
                id="ban-btn-{{ member.id }}">
                <i class="fas fa-user-slash me-1"></i> Ban
              </button>

              <!-- Unban button -->
              <button
                class="btn btn-sm btn-success toggle-status-btn {% if member.status|lower == 'active' %}d-none{% endif %}"
                data-member-id="{{ member.id }}"
                data-action="unban"
                data-url-unban="{% url 'unban_user' member.id %}"
                id="unban-btn-{{ member.id }}">
                <i class="fas fa-user-check me-1"></i> Unban
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center py-4">No members found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mt-4" id="pagination">
        <!-- Pagination will be added here by JavaScript -->
      </ul>
    </nav>
  </div>
</div>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

document.querySelectorAll(".toggle-status-btn").forEach(button => {
  button.addEventListener("click", async function () {
    const memberId = this.dataset.memberId;
    const action = this.dataset.action; // "ban" or "unban"
    const url = action === "ban" ? this.dataset.urlBan : this.dataset.urlUnban;

    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Accept": "application/json",
          "Content-Type": "application/json"
        }
      });
      const data = await res.json();

      if (!res.ok || !data.success) throw new Error();

      // Update badge + toggle buttons
      const badge = document.getElementById(`status-badge-${memberId}`);
      if (data.new_status === true) { // Active
        badge.innerHTML = '<i class="fas fa-check-circle me-1"></i> Active';
        badge.className = 'status-badge status-active';

        document.getElementById(`unban-btn-${memberId}`).classList.add("d-none");
        document.getElementById(`ban-btn-${memberId}`).classList.remove("d-none");

      } else { // Banned
        badge.innerHTML = '<i class="fas fa-ban me-1"></i> Banned';
        badge.className = 'status-badge status-banned';

        document.getElementById(`ban-btn-${memberId}`).classList.add("d-none");
        document.getElementById(`unban-btn-${memberId}`).classList.remove("d-none");
      }

    } catch (err) {
      console.error("Failed to update member:", err);
    } finally {
      this.disabled = false;
    }
  });
});
</script>

<!---- Custom JS ---->
<script src="{% static 'DASHBOARD/JS/allmembers.js' %}"></script>
</body>
</html>
